SELECT /*+PARALLEL(210)*/COUNT(A.INVEST_ID) 笔数, SUM(A.INTEREST) 金额
  FROM DEV_PAS.T_FUND_SETTLEMENT@BINGXING_168_15 A
  JOIN DEV_PAS.T_CONTRACT_INVEST@BINGXING_168_15 B
    ON A.INVEST_ID = B.LIST_ID
  JOIN DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15 C
    ON B.POLICY_ID = C.POLICY_ID
 WHERE A.SETTLE_DATE = TRUNC(SYSDATE)-1
   AND C.ORGAN_CODE IN
       (SELECT T.ORGAN_CODE
          FROM APP___PAS__DBUSER.T_UDMP_ORG_REL@BINGXING_168_15 T
         START WITH T.ORGAN_CODE = '8647'
        CONNECT BY PRIOR T.ORGAN_CODE = T.UPORGAN_CODE);
        
SELECT /*+PARALLEL(210)*/COUNT(DISTINCT A.CONTNO) AS 总笔数, SUM(A.MONEY) AS 总金额
  FROM LIS.LCINSUREACCTRACE A
  JOIN LIS.LMRISKTYPE B
    ON A.RISKCODE = B.RISKCODE
  JOIN LIS.LCCONT D
    ON A.CONTNO = D.CONTNO
  LEFT JOIN LIS.LMINSUACCRATE E
    ON A.INSUACCNO = E.INSUACCNO
   AND A.RISKCODE = E.RISKCODE
   AND A.PAYDATE = E.BALADATE
   AND E.RATEINTV = 'Y'
 WHERE A.MONEYTYPE = 'LX'
   AND D.CONTTYPE = '1'
   AND D.MANAGECOM LIKE '8647%'
   AND D.APPFLAG IN ('1', '4')
   AND A.PAYDATE <= TRUNC(SYSDATE)-1
   AND A.PAYDATE >= TRUNC(SYSDATE)-1
   AND B.RISKTYPE1 = '3';
   
/************************************************  明细  *************************************************************/
CREATE TABLE  TMP_NCS_1001  AS
--DELETE FROM TMP_NCS_1001;
--COMMIT;
--INSERT INTO TMP_NCS_1001
SELECT/*+PARALLEL(210)*/ C.POLICY_CODE   AS POLICY_CODE, --保单号
       A.INTEREST_RATE AS INTEREST_RATE, --结算利率
       A.INTEREST      AS INTEREST --结算利息
  FROM DEV_PAS.T_FUND_SETTLEMENT@BINGXING_168_15 A
  JOIN DEV_PAS.T_CONTRACT_INVEST@BINGXING_168_15 B
    ON A.INVEST_ID = B.LIST_ID
  JOIN DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15 C
    ON B.POLICY_ID = C.POLICY_ID
 WHERE A.SETTLE_DATE = TRUNC(SYSDATE)-1
   AND C.ORGAN_CODE IN
       (SELECT T.ORGAN_CODE
          FROM APP___PAS__DBUSER.T_UDMP_ORG_REL@BINGXING_168_15 T
         START WITH T.ORGAN_CODE = '8647'
        CONNECT BY PRIOR T.ORGAN_CODE = T.UPORGAN_CODE);
COMMIT;

CREATE TABLE  TMP_LIS_1001  AS
--DELETE FROM TMP_LIS_1001;
--COMMIT;
--INSERT INTO TMP_LIS_1001
SELECT/*+PARALLEL(210)*/  A.CONTNO AS CONTNO ,E.RATE AS RATE, SUM(A.MONEY) AS MONEY
  FROM LIS.LCINSUREACCTRACE A
  JOIN LIS.LMRISKTYPE B
    ON A.RISKCODE = B.RISKCODE
  JOIN LIS.LCCONT D
    ON A.CONTNO = D.CONTNO
  LEFT JOIN LIS.LMINSUACCRATE E
    ON A.INSUACCNO = E.INSUACCNO
   AND A.RISKCODE = E.RISKCODE
   AND A.PAYDATE = E.BALADATE
   AND E.RATEINTV = 'Y'
 WHERE A.MONEYTYPE = 'LX'
   AND D.CONTTYPE = '1'
   AND D.MANAGECOM LIKE '8647%'
   AND D.APPFLAG IN ('1', '4')
   AND A.PAYDATE <= TRUNC(SYSDATE)-1
   AND A.PAYDATE >= TRUNC(SYSDATE)-1
   AND B.RISKTYPE1 = '3'
 GROUP BY E.RATE, A.CONTNO
 ORDER BY A.CONTNO;
 COMMIT;
 
SELECT/*+PARALLEL(210)*/ NVL(TRIM(T2.POLICY_CODE), TRIM(T1.CONTNO)) AS 保单号,
       NVL(T2.INTEREST_RATE, 0) AS 新核心结算利率,
       NVL(T2.INTEREST, 0) AS 新核心结算利息,
       NVL(T1.RATE, 0) AS 老核心结算利率,
       NVL(T1.MONEY, 0) AS 老核心结算利息,
       NVL(T2.INTEREST_RATE, 0) - NVL(T1.RATE, 0) AS 差异值,
       NVL(T2.INTEREST, 0) - NVL(T1.MONEY, 0) AS 差异分析
  FROM TMP_LIS_1001 T1
  FULL JOIN TMP_NCS_1001 T2
    ON TRIM(T1.CONTNO) = TRIM(T2.POLICY_CODE)
 ORDER BY T2.POLICY_CODE;




