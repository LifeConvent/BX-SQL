SELECT/*+PARALLEL(60)*/ COUNT(1) AS 批处理笔数, SUM(APPLY_UNITS) AS 单位数变化量
  FROM (SELECT TCM.POLICY_CODE,
               TCBP.BUSI_PROD_CODE,
               TCI.ACCOUNT_CODE,
               TCI.ACCUM_UNITS,
               TFT.APPLY_UNITS
          FROM DEV_PAS.T_FUND_TRANS_APPLY@BINGXING_168_15   TFT,
               DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15    TCM,
               DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15 TCBP,
               DEV_PAS.T_CONTRACT_INVEST@BINGXING_168_15    TCI
         WHERE TFT.POLICY_ID = TCM.POLICY_ID
 AND TCM.ORGAN_CODE LIKE '8647%'
 AND TFT.BUSI_ITEM_ID = TCBP.BUSI_ITEM_ID
 AND TCI.POLICY_ID = TFT.POLICY_ID
 AND TCI.BUSI_ITEM_ID = TCBP.BUSI_ITEM_ID
 AND TFT.FUND_PROCESS_STATUS = '1'
 AND TCBP.BUSI_PROD_CODE LIKE '008%'
 AND TFT.APPLY_TIME = TRUNC(SYSDATE)-1);
 
SELECT/*+PARALLEL(60)*/ COUNT(*) AS 老核心保单险种件数,
       NVL(SUM(LCINSUREACCTRACE.UNITCOUNT), 0) AS 老核心单位数变化量
  FROM LIS.LCINSUREACC
  LEFT JOIN LIS.LCINSUREACCTRACE
    ON LCINSUREACC.CONTNO = LCINSUREACCTRACE.CONTNO
   AND LCINSUREACC.POLNO = LCINSUREACCTRACE.POLNO
   AND LCINSUREACC.RISKCODE = LCINSUREACCTRACE.RISKCODE
  LEFT JOIN LIS.LCCONT
    ON LCCONT.CONTNO = LCINSUREACC.CONTNO
 WHERE LCINSUREACC.RISKCODE LIKE '008%'
   AND LCCONT.MANAGECOM LIKE '8647%' --机构
   --统计日期 = 实际计价日期
   AND LCINSUREACCTRACE.VALUEDATE = TRUNC(SYSDATE)-1;
   
/***************************************************** 明细 *************************************************/
--CREATE TABLE TMP_NCS_1012 AS
DELETE FROM TMP_NCS_1012
COMMIT;
INSERT INTO TMP_NCS_1012
SELECT TCM.POLICY_CODE,--保单号
       TCBP.BUSI_PROD_CODE,--产品编码
       TCI.ACCOUNT_CODE,--基金代码
       TCI.ACCUM_UNITS,--单位数
       TFT.APPLY_UNITS--单位变化量
  FROM DEV_PAS.T_FUND_TRANS_APPLY@BINGXING_168_15   TFT,
       DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15    TCM,
       DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15 TCBP,
       DEV_PAS.T_CONTRACT_INVEST@BINGXING_168_15    TCI
 WHERE TFT.POLICY_ID = TCM.POLICY_ID
   AND TCM.ORGAN_CODE LIKE '8647%'
   AND TFT.BUSI_ITEM_ID = TCBP.BUSI_ITEM_ID
   AND TCI.POLICY_ID = TFT.POLICY_ID
   AND TCI.BUSI_ITEM_ID = TCBP.BUSI_ITEM_ID
   AND TFT.FUND_PROCESS_STATUS = '1'
   AND TCBP.BUSI_PROD_CODE LIKE '008%'
   AND TFT.APPLY_TIME = TRUNC(SYSDATE)-1;
COMMIT;

--CREATE TABLE TMP_LIS_1012 AS
DELETE FROM TMP_LIS_1012;
COMMIT;
INSERT INTO TMP_LIS_1012
SELECT LCINSUREACC.CONTNO, --保单号
       LCINSUREACC.RISKCODE ,--产品编码
       LCINSUREACC.INSUACCNO, --基金代码
       LCINSUREACC.UNITCOUNT, --单位数
       LCINSUREACCTRACE.UNITCOUNT AS CHG_UNITCOUNT --单位数变化量
  FROM LIS.LCINSUREACC
  LEFT JOIN LIS.LCINSUREACCTRACE
    ON LCINSUREACC.CONTNO = LCINSUREACCTRACE.CONTNO
   AND LCINSUREACC.POLNO = LCINSUREACCTRACE.POLNO
   AND LCINSUREACC.RISKCODE = LCINSUREACCTRACE.RISKCODE
  LEFT JOIN LIS.LCCONT
    ON LCCONT.CONTNO = LCINSUREACC.CONTNO
 WHERE LCINSUREACC.RISKCODE LIKE '008%'
   AND LCCONT.MANAGECOM LIKE '8647%' --机构
   AND LCINSUREACCTRACE.VALUEDATE = TRUNC(SYSDATE)-1;
COMMIT;

SELECT CASE
         WHEN TRIM(T1.CONTNO) = TRIM(T2.POLICY_CODE) THEN
          TRIM(T1.CONTNO)
         WHEN TRIM(T1.CONTNO) IS NULL THEN
          TRIM(T2.POLICY_CODE)
         ELSE
          TRIM(T1.CONTNO)
       END AS 保单号,
       CASE
         WHEN TRIM(T1.RISKCODE) = TRIM(T2.BUSI_PROD_CODE) THEN
          TRIM(T1.RISKCODE)
         WHEN TRIM(T1.RISKCODE) IS NULL THEN
          TRIM(T2.BUSI_PROD_CODE)
         ELSE
          TRIM(T1.RISKCODE)
       END AS 产品编码,
       CASE
         WHEN TRIM(T1.INSUACCNO) = TRIM(T2.ACCOUNT_CODE) THEN
          TRIM(T1.INSUACCNO)
         WHEN TRIM(T1.INSUACCNO) IS NULL THEN
          TRIM(T2.ACCOUNT_CODE)
         ELSE
          TRIM(T1.INSUACCNO)
       END AS 基金代码,
       NVL(T1.UNITCOUNT, 0) AS 老核心单位数,
       NVL(T1.CHG_UNITCOUNT, 0) AS 老核心单位数变化量,
       NVL(T2.ACCUM_UNITS, 0) AS 新核心单位数,
       NVL(T2.APPLY_UNITS, 0) AS 新核心单位数变化量,
       NVL(T1.UNITCOUNT, 0) - NVL(T2.ACCUM_UNITS, 0) AS 差异单位数,
       NVL(T1.CHG_UNITCOUNT, 0) - NVL(T2.APPLY_UNITS, 0) AS 差异单位数变化量
  FROM TMP_LIS_1012 T1
  FULL JOIN TMP_NCS_1012 T2
    ON TRIM(T1.CONTNO) = TRIM(T2.POLICY_CODE)
   AND TRIM(T1.RISKCODE) = TRIM(T2.BUSI_PROD_CODE)
   AND TRIM(T1.INSUACCNO) = TRIM(T2.ACCOUNT_CODE)
 ORDER BY T2.POLICY_CODE;



