SELECT COUNT(1) 笔数
   FROM DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15 TBP
   JOIN DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15 TCM
     ON TBP.POLICY_CODE = TCM.POLICY_CODE
  WHERE TBP.LIABILITY_STATE = 4
    AND TCM.ORGAN_CODE LIKE '8647%'
    AND TBP.LAPSE_DATE = TRUNC(SYSDATE)-1 --失效日期
    AND TBP.LAPSE_CAUSE = '1';


SELECT 
   COUNT(1) AS 笔数 
   FROM LIS.LCPOL A
  INNER JOIN LIS.LCCONT C
     ON A.CONTNO = C.CONTNO
   LEFT JOIN LIS.LCCONTSTATE B
     ON A.CONTNO = B.CONTNO
    AND A.POLNO = B.POLNO
  WHERE C.MANAGECOM LIKE '8647%'
    AND B.MAKEDATE = TRUNC(SYSDATE)-1  --失效日期
    AND B.STATETYPE = 'Available'
    AND B.STATE = '1'
    AND A.CONTTYPE = '1'
    AND EXISTS
  (SELECT 1 FROM LIS.LJSPAYPERSON E WHERE A.CONTNO = E.CONTNO);

  

DELETE FROM TMP_NCS_1008;
COMMIT;
INSERT INTO TMP_NCS_1008
--CREATE TABLE  TMP_NCS_1008  AS
 SELECT TBP.POLICY_CODE,--保单号
  TBP.BUSI_PROD_CODE,--产品编码
  TBP.LIABILITY_STATE,--效力状态
 TBP.LAPSE_CAUSE--失效原因
  FROM DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15 TBP
  JOIN DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15 TCM
    ON TBP.POLICY_CODE = TCM.POLICY_CODE
 WHERE TBP.LIABILITY_STATE = 4  
   AND TCM.ORGAN_CODE LIKE '8647%'
   AND TBP.LAPSE_DATE = TRUNC(SYSDATE)-1  --失效日期
   AND TBP.LAPSE_CAUSE = '1'
 ORDER BY TBP.POLICY_CODE;
COMMIT;



DELETE FROM TMP_LIS_1008;
COMMIT;
INSERT INTO TMP_LIS_1008
--CREATE TABLE  TMP_LIS_1008 AS
 SELECT
        C.CONTNO, 
        A.RISKCODE, 
        A.APPFLAG,
        '普通失效'  AS RENSON
   FROM LIS.LCPOL A
  INNER JOIN LIS.LCCONT C
     ON A.CONTNO = C.CONTNO
   LEFT JOIN LIS.LCCONTSTATE B
     ON A.CONTNO = B.CONTNO
    AND A.POLNO = B.POLNO
  WHERE C.MANAGECOM LIKE '8647%'
    AND B.MAKEDATE = TRUNC(SYSDATE)-1 --失效日期
    AND B.STATETYPE = 'Available'
    AND B.STATE = '1'
    AND A.CONTTYPE = '1'
    AND EXISTS
  (SELECT 1 FROM LIS.LJSPAYPERSON E WHERE A.CONTNO = E.CONTNO)
  ORDER BY C.CONTNO;
COMMIT;



SELECT   
 COALESCE(TRIM(T2.POLICY_CODE), TRIM(T1.CONTNO)) AS 保单号,
 COALESCE(TRIM(T2.BUSI_PROD_CODE), TRIM(T1.RISKCODE)) AS 产品编码,
 APPFLAG 老核心效力状态,
 RENSON 老核心失效原因,
 LIABILITY_STATE 新核心效力状态,
 LAPSE_CAUSE 新核心失效原因，(CASE
   WHEN (T2.LIABILITY_STATE = 4 AND T1.APPFLAG = '1') THEN
    '否'
   ELSE
    '是'
 END) AS 差异
  FROM TMP_LIS_1008 T1
  FULL JOIN TMP_NCS_1008 T2
    ON TRIM(T1.CONTNO) = TRIM(T2.POLICY_CODE)
   AND TRIM(T2.BUSI_PROD_CODE) = TRIM(T1.RISKCODE);
