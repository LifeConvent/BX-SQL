
   
SELECT COUNT(DISTINCT B.POLICY_ID) AS 笔数,
       SUM(B.CASH_BONUS) 现金红利,
       SUM(B.REISSUE_INTEREST) 补发利息
  FROM DEV_PAS.T_BONUS_ALLOCATE@BINGXING_168_15 B
  LEFT JOIN DEV_PAS.T_CONTRACT_PRODUCT@BINGXING_168_15 TCP
    ON TCP.POLICY_ID = B.POLICY_ID
 WHERE B.BONUS_ALLOT = 4
   AND TCP.ORGAN_CODE LIKE '8647%' --机构编号
   --分配日期
   AND B.ALLOCATE_DATE = TRUNC(SYSDATE)-1;

SELECT COUNT(DISTINCT A.CONTNO) AS 笔数,
       SUM(A.CASHBONUS) AS 现金红利,
       SUM(A.BONUSINTEREST) AS 补发利息
  FROM LIS.LOAMEBONUSPOL A
 WHERE 1 = 1
      --AND A.PAYMODE = 'W' --现金分红 方式待定
   AND A.CONTNO IN (SELECT CONTNO
                      FROM LIS.LCPOL B
                     WHERE B.CONTTYPE = '1'
                       AND B.MANAGECOM LIKE '8647%')
   AND A.SDISPATCHDATE = TRUNC(SYSDATE) - 1;

       
/************************************************ 明细 ************************************************/

--CREATE TABLE  TMP_NCS_1018  AS
DELETE FROM TMP_NCS_1018;
COMMIT;
INSERT INTO TMP_NCS_1018
SELECT TCP.POLICY_CODE, --保单号
       TCP.PRODUCT_CODE, --责任组代码
       TO_CHAR(B.ALLOCATE_DUE_DATE, 'yyyy') - 1 FISCALYEAR, --会计年度 
       B.BONUS_RATE, -- 红利率      
       B.CASH_BONUS, --现金红利金额
       B.REISSUE_INTEREST --补发利息
  FROM DEV_PAS.T_BONUS_ALLOCATE@BINGXING_168_15 B
  LEFT JOIN DEV_PAS.T_CONTRACT_PRODUCT@BINGXING_168_15 TCP
    ON TCP.POLICY_ID = B.POLICY_ID
 WHERE B.BONUS_ALLOT = 4
   AND TCP.ORGAN_CODE LIKE '8647%' --机构编号
   AND B.ALLOCATE_DATE = TRUNC(SYSDATE)-1 --分配日期
 ORDER BY 1;
COMMIT;


--CREATE TABLE  TMP_LIS_1018  AS
DELETE FROM TMP_LIS_1018;
COMMIT;
INSERT INTO TMP_LIS_1018
SELECT A.CONTNO,
       A.DUTYCODE,
       A.FISCALYEAR,
       SUM(A.CASHBONUS) AS CASHBONUS,
       SUM(A.BONUSINTEREST) AS BONUSINTEREST
  FROM LIS.LOAMEBONUSPOL A
 WHERE 1 = 1
      --AND A.PAYMODE = '1' --现金分红 方式待定
   AND A.CONTNO IN (SELECT /*+ parallel(50) */
                     CONTNO
                      FROM LIS.LCPOL B
                     WHERE B.CONTTYPE = '1'
                       AND B.MANAGECOM LIKE '8647%')
   AND A.SDISPATCHDATE = TRUNC(SYSDATE) - 1 --分红日期
 GROUP BY A.CONTNO, A.DUTYCODE, A.FISCALYEAR;
COMMIT;


SELECT NVL(TRIM(T2.POLICY_CODE), TRIM(T1.CONTNO)) AS 保单号,
      NVL(T1.DUTYCODE, T2.PRODUCT_CODE) AS 老核心保单号,
      NVL(T1.FISCALYEAR, T2.FISCALYEAR) AS 会计年度,
      T2.BONUS_RATE AS 红利率,
      SUM(T2.CASH_BONUS) 现金红利新核心,
      SUM(T1.CASHBONUS) 现金红利老核心,
      SUM(T2.REISSUE_INTEREST) 补发利息新核心,
      SUM(T1.BONUSINTEREST) 补发利息老核心,
      SUM(T2.CASH_BONUS - T1.CASHBONUS) 差异现金红利,
      SUM(T2.REISSUE_INTEREST - T1.BONUSINTEREST) 差异补发利息
 FROM TMP_LIS_1018 T1
 FULL JOIN TMP_NCS_1018 T2
   ON TRIM(T1.CONTNO) = TRIM(T2.POLICY_CODE)
GROUP BY NVL(TRIM(T2.POLICY_CODE), TRIM(T1.CONTNO)),
         NVL(T1.DUTYCODE, T2.PRODUCT_CODE),
         NVL(T1.FISCALYEAR, T2.FISCALYEAR),
         T2.BONUS_RATE;





