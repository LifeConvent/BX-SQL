SELECT COUNT(DISTINCT A.POLICY_CODE) AS 笔数, SUM(A.FEE_AMOUNT) AS 金额
  FROM DEV_PAS.T_PAY_DUE@BINGXING_168_15 A --生存金给付应领表
  JOIN DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15 D --保单主表
    ON A.POLICY_ID = D.POLICY_ID
  JOIN DEV_PAS.T_PAY_PLAN@BINGXING_168_15 DD --生存给付计划表
    ON A.PLAN_ID = DD.PLAN_ID
 WHERE 1 = 1
   AND DD.PAY_PLAN_TYPE IN ('3', '10', '11') --生存金给付类型
   AND D.ORGAN_CODE LIKE '8647%' --青岛分公司
   AND D.LIABILITY_STATE <> 3 --不为终止状态
   AND A.FEE_STATUS = '01'
   AND A.PAY_DUE_DATE = TRUNC(SYSDATE) - 1;

   
SELECT COUNT(DISTINCT T1.CONTNO) AS 笔数, SUM(T1.GETMONEY) AS 金额
  FROM LIS.LJAGETDRAW T1
  LEFT JOIN LIS.LMDUTYGET T2
    ON T1.GETDUTYCODE = T2.GETDUTYCODE
  LEFT JOIN LIS.LCCONT T3
    ON T1.CONTNO = T3.CONTNO
 WHERE T3.CONTTYPE = '1'
   AND T3.APPFLAG IN ('1')
   AND T3.MANAGECOM LIKE '8647%'
   AND T2.GETTYPE1 IN ('1') --0：代表满期金； 1代表生存金
   AND T1.GETDATE = TRUNC(SYSDATE)-1;

   
/************************************************************ 明细 ************************************************/

DELETE FROM TMP_NCS_1022;
COMMIT;
INSERT INTO TMP_NCS_1022
--CREATE TABLE TMP_NCS_1022 AS
SELECT DISTINCT A.POLICY_CODE AS POLICY_CODE, --保单号
                SUM(A.FEE_AMOUNT) AS FEE_AMOUNT --发放金额
  FROM DEV_PAS.T_PAY_DUE@BINGXING_168_15 A --生存金给付应领表
  JOIN DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15 D --保单主表
    ON A.POLICY_ID = D.POLICY_ID
  JOIN DEV_PAS.T_PAY_PLAN@BINGXING_168_15 DD --生存给付计划表
    ON A.PLAN_ID = DD.PLAN_ID
 WHERE 1 = 1
   AND DD.PAY_PLAN_TYPE IN ('3', '10', '11') --生存金给付类型
   AND D.ORGAN_CODE LIKE '8647%' --青岛分公司
   AND D.LIABILITY_STATE <> 3 --不为终止状态
   AND A.FEE_STATUS = '01'
   AND A.PAY_DUE_DATE = TRUNC(SYSDATE) - 1
 GROUP BY A.POLICY_CODE;
COMMIT;


DELETE FROM TMP_LIS_1022;
COMMIT;
INSERT INTO TMP_LIS_1022
--CREATE TABLE  TMP_LIS_1022  AS
SELECT  T1.CONTNO AS CONTNO, SUM(T1.GETMONEY)AS GETMONEY
  FROM LIS.LJAGETDRAW T1
  LEFT JOIN LIS.LMDUTYGET T2
    ON T1.GETDUTYCODE = T2.GETDUTYCODE
  LEFT JOIN LIS.LCCONT T3
    ON T1.CONTNO = T3.CONTNO
 WHERE T3.CONTTYPE = '1'
   AND T3.APPFLAG IN ('1')
   AND T3.MANAGECOM LIKE '8647%'
   AND T2.GETTYPE1 IN ('1') --0：代表满期金； 1代表生存金
   AND T1.GETDATE = TRUNC(SYSDATE)-1
 GROUP BY T1.CONTNO;
COMMIT;


SELECT   NVL(TRIM(T2.POLICY_CODE),TRIM(T1.CONTNO)) AS 新核心保单号,
       NVL(T2.FEE_AMOUNT, 0) AS 新核心生存金,
       NVL(T1.GETMONEY, 0) AS 老核心生存存金,
       NVL(T2.FEE_AMOUNT, 0) - NVL(T1.GETMONEY, 0) AS 差异值
  FROM TMP_LIS_1022 T1
  FULL JOIN TMP_NCS_1022 T2
    ON TRIM(T1.CONTNO) = TRIM(T2.POLICY_CODE)
 ORDER BY T2.POLICY_CODE;




