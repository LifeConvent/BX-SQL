SELECT/*+PARALLEL(60)*/ COUNT(1) AS 批处理笔数, SUM(TOTAL_PREM_AF) AS 保费
  FROM (SELECT CM.POLICY_CODE,
               CBP.BUSI_PROD_CODE,
               CBP.LIABILITY_STATE,
               CP.TOTAL_PREM_AF,
               CP.AMOUNT,
               CBP.VALIDATE_DATE,
               CBP.EXPIRY_DATE,
               CBP.MATURITY_DATE
          FROM DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15     CM,
               DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15  CBP,
               DEV_PAS.T_CONTRACT_PRODUCT@BINGXING_168_15    CP,
               DEV_PAS.T_RENEWAL_BILLING@BINGXING_168_15     TRB
         WHERE CM.POLICY_ID = CBP.POLICY_ID
           AND CBP.BUSI_ITEM_ID = CP.BUSI_ITEM_ID
           AND TRB.POLICY_ID = CBP.POLICY_ID
           AND TRB.BUSI_ITEM_ID = CBP.BUSI_ITEM_ID
           AND TRB.RENEWAL_STATE = '1'
           AND TRUNC(TRB.UPDATE_TIME) = TRUNC(SYSDATE)-1
           AND CM.ORGAN_CODE LIKE '8647%');
           
SELECT/*+PARALLEL(60)*/ COUNT(A.POLNO) AS 续保件数,
       SUM((SELECT SUM(SUMACTUPAYMONEY)
             FROM LIS.LJAPAYPERSON D
            WHERE A.POLNO = D.POLNO)) AS 续保保费合计
  FROM LIS.LCPOL A
 WHERE CONTTYPE = '1'
   AND APPFLAG = '1'
   AND RISKCODE IN (SELECT RISKCODE FROM LIS.LMRISK WHERE RNEWFLAG = 'Y')
   AND A.CVALIDATE = TRUNC(SYSDATE)-1
   AND A.MANAGECOM LIKE '8647%';
   
/*********************************************************  明细 *******************************************************/
--CREATE TABLE  TMP_NCS_1017  AS
DELETE FROM TMP_NCS_1017;
COMMIT;
INSERT INTO TMP_NCS_1017
SELECT/*+PARALLEL(60)*/ CM.POLICY_CODE, -- 保单号
               CBP.BUSI_PROD_CODE, -- 产品编码
               CBP.LIABILITY_STATE, -- 保单状态
               CP.TOTAL_PREM_AF, -- 保费
               CP.AMOUNT, -- 保额
               CBP.VALIDATE_DATE, -- 生效日期
               CBP.EXPIRY_DATE -- 终止日期
          FROM DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15     CM,
               DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15  CBP,
               DEV_PAS.T_CONTRACT_PRODUCT@BINGXING_168_15    CP,
               DEV_PAS.T_RENEWAL_BILLING@BINGXING_168_15     TRB
         WHERE CM.POLICY_ID = CBP.POLICY_ID
           AND CBP.BUSI_ITEM_ID = CP.BUSI_ITEM_ID
           AND TRB.POLICY_ID = CBP.POLICY_ID
           AND TRB.BUSI_ITEM_ID = CBP.BUSI_ITEM_ID
           AND TRB.RENEWAL_STATE = '1'
           AND TRUNC(TRB.UPDATE_TIME) = TRUNC(SYSDATE)-1
           AND CM.ORGAN_CODE LIKE '8647%';
COMMIT;

--CREATE TABLE  TMP_LIS_1017  AS
DELETE FROM TMP_LIS_1017;
COMMIT;
INSERT INTO TMP_LIS_1017
SELECT/*+PARALLEL(60)*/ A.CONTNO AS CONTNO,
       A.RISKCODE AS RISKCODE,
       CODEMAPPING_STATE.NEW_CODE AS APPFLAG,
       NVL((SELECT SUM(SUMACTUPAYMONEY)
             FROM LIS.LJAPAYPERSON D
            WHERE A.POLNO = D.POLNO),
           0) AS SUMPREM,
       A.CVALIDATE AS CVALIDATE,
       CASE
         WHEN LCCONTSTATE.STATETYPE = 'Terminate' THEN
          LCCONTSTATE.STARTDATE
         ELSE
          A.ENDDATE
       END AS STARTDATE
  FROM LIS.LCPOL A
  LEFT JOIN (SELECT CODETYPE, OLD_CODE, NEW_CODE
               FROM T_CODEMAPPING
              WHERE CODETYPE = 'LIABILITY_STATE'
                AND FROM_MODLE = 'PAS'
                AND FLAG = '1') CODEMAPPING_STATE -- 效力状态转为新核心代码
    ON CODEMAPPING_STATE.OLD_CODE = A.APPFLAG
  LEFT JOIN LIS.LCCONTSTATE LCCONTSTATE
    ON A.POLNO = LCCONTSTATE.POLNO
 WHERE CONTTYPE = '1'
   AND APPFLAG = '1'
   AND RISKCODE IN (SELECT RISKCODE FROM LIS.LMRISK WHERE RNEWFLAG = 'Y')
   AND A.CVALIDATE = TRUNC(SYSDATE)-1
   AND A.MANAGECOM LIKE '8647%'
 ORDER BY A.CONTNO;
 COMMIT;
 
SELECT/*+PARALLEL(60)*/ NVL(T1.CONTNO, T2.POLICY_CODE) AS 保单号,
       NVL(T1.RISKCODE, T2.BUSI_PROD_CODE) AS 产品编码,
       T1.APPFLAG AS 老核心险种状态,
       T1.SUMPREM AS 老核心保费,
       T1.CVALIDATE AS 老核心生效日期,
       T1.STARTDATE AS 老核心终止日期,
       T2.LIABILITY_STATE AS 新核心险种状态,
       T2.TOTAL_PREM_AF AS 新核心保费,
       T2.VALIDATE_DATE AS 新核心生效日期,
       T2.EXPIRY_DATE AS 新核心终止日期,
       DECODE(TRIM(T1.APPFLAG), TRIM(T2.LIABILITY_STATE), 'Y', 'N') AS 险种状态,
       T1.SUMPREM - T2.TOTAL_PREM_AF AS 保费差异
  FROM TMP_LIS_1017 T1
  FULL JOIN TMP_NCS_1017 T2
    ON TRIM(T1.CONTNO) = TRIM(T2.POLICY_CODE)
   AND TRIM(T1.RISKCODE) = TRIM(T2.BUSI_PROD_CODE)
 ORDER BY T2.POLICY_CODE;




