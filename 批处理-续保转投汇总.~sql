/*续保转投前：*/
SELECT/*+PARALLEL(60)*/ COUNT(1) 批处理笔数
  FROM (SELECT TCBP.POLICY_CODE,
               TCBP.BUSI_PROD_CODE,
               TCBP.LIABILITY_STATE,
               TCBP.END_CAUSE,
               TCBP.EXPIRY_DATE
          FROM DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15    TCM,
               DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15 TCBP
         WHERE TCM.ORGAN_CODE LIKE '8647%'
           AND TCM.EXPIRY_DATE + 1 = TRUNC(SYSDATE)-1
           AND TCBP.POLICY_ID = TCM.FORMER_ID
           AND TCBP.BUSI_PROD_CODE IN ('00563100', '00958100'));

/*续保转投后：*/
SELECT/*+PARALLEL(60)*/ COUNT(1) 批处理笔数
  FROM (SELECT TCBO.POLICY_CODE,
               TCBO.BUSI_PROD_CODE,
               TCBO.LIABILITY_STATE,
               (SELECT TCBP.POLICY_CODE
                  FROM DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15    TC,
                       DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15 TCBP
                 WHERE TC.POLICY_CODE = TCM.POLICY_CODE
                   AND TC.FORMER_ID = TCBP.POLICY_ID
                   AND ROWNUM <= 1
                   AND TCBP.BUSI_PROD_CODE IN ('00563000', '00958000')) OLD_POLICY_CODE,
               TCBO.VALIDATE_DATE,
               TCP.TOTAL_PREM_AF,
               TCP.AMOUNT
          FROM DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15 TCBO,
               DEV_PAS.T_CONTRACT_PRODUCT@BINGXING_168_15   TCP,
               DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15    TCM
         WHERE TCBO.POLICY_CODE = TCM.POLICY_CODE
           AND TCP.BUSI_ITEM_ID = TCBO.BUSI_ITEM_ID
           AND TCBO.BUSI_PROD_CODE IN ('00563000', '00958000')
           AND TCM.ORGAN_CODE LIKE '8647%'
           AND TCM.POLICY_CODE = TCBO.POLICY_CODE
           AND TCM.EXPIRY_DATE + 1 = TRUNC(SYSDATE)-1);
           
/*续保转投前：*/        
SELECT/*+PARALLEL(60)*/ COUNT(C.POLNO) AS 转投前保单险种件数
  FROM LIS.LCPOL C
 INNER JOIN LIS.LCCONTSTATE E
    ON C.CONTNO = E.CONTNO
 WHERE C.RISKCODE IN ('00563100', '00958100')
   AND E.STATETYPE = 'Terminate'
   AND E.STATE = '1'
   AND E.STARTDATE = TRUNC(SYSDATE)-1
   AND C.MANAGECOM LIKE '8647%'
   AND EXISTS (SELECT 1
          FROM LIS.LCPOL A
         INNER JOIN LIS.LCCONT B
            ON A.CONTNO = B.CONTNO
         WHERE A.STANDBYFLAG3 = TRIM(C.CONTNO)
           AND A.RISKCODE IN ('00563000', '00958000')
           AND B.CONTTYPE = '1');

/*统计概况转投后*/ 
SELECT/*+PARALLEL(60)*/ COUNT(DISTINCT A.POLNO) AS 转投后保单险种件数
  FROM LIS.LCPOL A
 WHERE RISKCODE IN ('00563000', '00958000')
   AND A.CONTTYPE = '1'
   AND A.APPFLAG = '1'
   AND A.CVALIDATE = TRUNC(SYSDATE)-1
   AND A.MANAGECOM LIKE '8647%'
   AND EXISTS (SELECT 1
          FROM LIS.LCPOL C
         WHERE A.STANDBYFLAG3 = TRIM(C.CONTNO)
           AND C.RISKCODE IN ('00563100', '00958100'));

/*************************************************** 明细 ******************************************************/
/*续保转投前 */                                                                                                                                             
--CREATE TABLE  TMP_NCS_1015  AS
DELETE FROM TMP_NCS_1015;
COMMIT;
INSERT INTO TMP_NCS_1015
SELECT /*+PARALLEL(60)*/TCBP.POLICY_CODE, -- 保单号
               TCBP.BUSI_PROD_CODE, -- 产品编码
               TCBP.LIABILITY_STATE, -- 保单状态
               TCBP.END_CAUSE, -- 终止原因
               TCBP.EXPIRY_DATE -- 终止日期
          FROM DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15    TCM,
               DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15 TCBP
         WHERE TCM.ORGAN_CODE LIKE '8647%'  AND TCM.EXPIRY_DATE + 1 = TRUNC(SYSDATE)-1
           AND TCBP.POLICY_ID = TCM.FORMER_ID
           AND TCBP.BUSI_PROD_CODE IN ('00563100', '00958100');
COMMIT;                                                                                                
/*续保转投后：*/                                                                                                                                                
--CREATE TABLE  TMP_NCS_1016  AS
DELETE FROM TMP_NCS_1016;
COMMIT;
INSERT INTO TMP_NCS_1016                                                                                                                             
SELECT /*+PARALLEL(60)*/TCBO.POLICY_CODE, -- 保单号
               TCBO.BUSI_PROD_CODE, -- 产品编码
               TCBO.LIABILITY_STATE, -- 保单状态
               TCP.TOTAL_PREM_AF, --保费
               TCP.AMOUNT, -- 保额
               (SELECT TCBP.POLICY_CODE
                  FROM DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15    TC,
                       DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15 TCBP
                 WHERE TC.POLICY_CODE = TCM.POLICY_CODE
                   AND TC.FORMER_ID = TCBP.POLICY_ID
                   AND ROWNUM <= 1
                   AND TCBP.BUSI_PROD_CODE IN ('00563000', '00958000')) OLD_POLICY_CODE -- 原保单号
          FROM DEV_PAS.T_CONTRACT_BUSI_PROD@BINGXING_168_15 TCBO,
               DEV_PAS.T_CONTRACT_PRODUCT@BINGXING_168_15   TCP,
               DEV_PAS.T_CONTRACT_MASTER@BINGXING_168_15    TCM
         WHERE TCBO.POLICY_CODE = TCM.POLICY_CODE
           AND TCP.BUSI_ITEM_ID = TCBO.BUSI_ITEM_ID
           AND TCBO.BUSI_PROD_CODE IN ('00563000', '00958000')
           AND TCM.ORGAN_CODE LIKE '8647%'
           AND TCM.POLICY_CODE = TCBO.POLICY_CODE
           AND TCM.EXPIRY_DATE + 1 = TRUNC(SYSDATE)-1;
COMMIT;

/*续保转投前：*/  
CREATE TABLE  TMP_LIS_1015  AS
--DELETE FROM TMP_LIS_1015;
--COMMIT;
--INSERT INTO TMP_LIS_1015
SELECT /*+PARALLEL(60)*/C.CONTNO,
       C.RISKCODE,
       CODEMAPPING_STATE.NEW_CODE     AS APPFLAG,
       CODEMAPPING_END_CAUSE.NEW_CODE AS STATEREASON,
       E.STARTDATE
  FROM LIS.LCPOL C
 INNER JOIN LIS.LCCONTSTATE E
    ON C.POLNO = E.POLNO
  LEFT JOIN (SELECT CODETYPE, OLD_CODE, NEW_CODE
               FROM T_CODEMAPPING
              WHERE CODETYPE = 'LIABILITY_STATE'
                AND FROM_MODLE = 'PAS'
                AND FLAG = '1') CODEMAPPING_STATE -- 效力状态转为新核心代码
    ON CODEMAPPING_STATE.OLD_CODE = C.APPFLAG
  LEFT JOIN (SELECT CODETYPE, OLD_CODE, NEW_CODE
               FROM T_CODEMAPPING
              WHERE CODETYPE = 'END_CAUSE'
                AND FROM_MODLE = 'PAS'
                AND FLAG = '1') CODEMAPPING_END_CAUSE -- 终止原因转为新核心代码
    ON TRIM(CODEMAPPING_END_CAUSE.OLD_CODE) = TRIM(E.STATEREASON)
 WHERE C.RISKCODE IN ('00563100', '00958100')
   AND E.STATETYPE = 'Terminate'
   AND E.STATE = '1'
   AND E.STARTDATE = TRUNC(SYSDATE)-1
   AND C.MANAGECOM LIKE '8647%'
   AND EXISTS (SELECT 1
          FROM LIS.LCPOL A
         WHERE A.CONTTYPE = '1'
           AND A.RISKCODE IN ('00563000', '00958000')
           AND A.STANDBYFLAG3 = TRIM(C.CONTNO));
COMMIT;
/*续保转投后：*/  
--CREATE TABLE  TMP_LIS_1016  AS
DELETE FROM TMP_LIS_1016;
COMMIT;
INSERT INTO TMP_LIS_1016
SELECT /*+PARALLEL(60)*/A.CONTNO,
       A.RISKCODE,
       CODEMAPPING_STATE.NEW_CODE AS APPFLAG,
       NVL((SELECT SUM(SUMACTUPAYMONEY)
             FROM LIS.LJAPAYPERSON D
            WHERE A.POLNO = D.POLNO),
           0) SUMPREM,
       A.AMNT AMNT,
       A.STANDBYFLAG3
  FROM LIS.LCPOL A
  LEFT JOIN (SELECT CODETYPE, OLD_CODE, NEW_CODE
               FROM T_CODEMAPPING
              WHERE CODETYPE = 'LIABILITY_STATE'
                AND FROM_MODLE = 'PAS'
                AND FLAG = '1') CODEMAPPING_STATE -- 效力状态转为新核心代码
    ON CODEMAPPING_STATE.OLD_CODE = A.APPFLAG
 WHERE A.RISKCODE IN ('00563000', '00958000')
   AND A.CONTTYPE = '1'
   AND A.APPFLAG = '1'
   AND A.CVALIDATE = TRUNC(SYSDATE)-1
   AND A.MANAGECOM LIKE '8647%'
   AND EXISTS (SELECT 1
          FROM LIS.LCPOL C
         WHERE A.STANDBYFLAG3 = TRIM(C.CONTNO)
           AND C.RISKCODE IN ('00563100', '00958100'));
COMMIT;

/***********************************************************  差异 *******************************************************/
/*续保转投前：*/  
SELECT /*+PARALLEL(60)*/DECODE(T1.CONTNO, NULL, T2.POLICY_CODE, T1.CONTNO) AS 保单号,
       DECODE(T1.RISKCODE, NULL, T2.BUSI_PROD_CODE, T1.RISKCODE) AS 产品编码,
       T1.APPFLAG AS 险种状态,
       T1.STATEREASON AS 终止原因,
       T1.STARTDATE AS 终止日期,
       T2.LIABILITY_STATE AS 险种状态,
       T2.END_CAUSE AS 终止原因,
       T2.EXPIRY_DATEE AS 终止日期,
       DECODE(TRIM(T1.APPFLAG), TRIM(T2.LIABILITY_STATE), 'Y', 'N') AS 差异
  FROM TMP_LIS_1015 T1
  FULL JOIN TMP_NCS_1015 T2
    ON TRIM(T1.CONTNO) = TRIM(T2.POLICY_CODE)
   AND TRIM(T1.RISKCODE) = TRIM(T2.BUSI_PROD_CODE)
 ORDER BY T2.POLICY_CODE;
 
/*续保转投后：*/ 
SELECT /*+PARALLEL(60)*/DECODE(T1.CONTNO, NULL, T2.POLICY_CODE, T1.CONTNO) AS 保单号,
       DECODE(T1.RISKCODE, NULL, T2.BUSI_PROD_CODE, T1.RISKCODE) AS 产品编码,
       T1.APPFLAG AS 险种状态,
       T1.SUMPREM AS 保费,
       T1.AMNT AS 保额,
       T1.STANDBYFLAG3 AS 原保单号,
       T2.LIABILITY_STATE AS 险种状态,
       T2.TOTAL_PREM_AF AS 保费,
       T2.AMOUNT AS 保额,
       T2.OLD_POLICY_CODE AS 原保单号,
       T1.SUMPREM - T2.TOTAL_PREM_AF,
       T1.AMNT - T2.AMOUNT
  FROM TMP_LIS_1016 T1
  FULL JOIN TMP_NCS_1016 T2
    ON TRIM(T1.CONTNO) = TRIM(T2.POLICY_CODE)
   AND TRIM(T1.RISKCODE) = TRIM(T2.BUSI_PROD_CODE)
 ORDER BY T2.POLICY_CODE;

